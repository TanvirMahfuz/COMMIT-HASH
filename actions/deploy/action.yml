name: Deploy Docker to VM
description: Pull and run Docker container on remote VM

inputs:
  vm-ip:
    required: true
    description: "IP address of the VM"
  vm-user:
    required: true
    description: "SSH user"
  dockerhub-username:
    required: true
    description: "DockerHub username"
  ssh-private-key:
    required: true

runs:
  using: "composite"
  steps:
    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ inputs.ssh-private-key }}

    - name: Deploy Docker container
      shell: bash
      run: |
        ssh -o StrictHostKeyChecking=no ${{ inputs.vm-user }}@${{ inputs.vm-ip }} "
          docker pull ${{ inputs.dockerhub-username }}/simple-github-commit-hash-printer:latest &&
          docker stop simple-github-commit-hash-printer || true &&
          docker rm simple-github-commit-hash-printer || true &&
          docker run -d --name simple-github-commit-hash-printer -p 3000:3000 ${{ inputs.dockerhub-username }}/simple-github-commit-hash-printer:latest
        "
